---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Navbar from '../../components/Navbar';
import InventarioMateriales from '../../components/inventario/InventarioMateriales';

// Proteger esta ruta - Solo usuarios autenticados
export const prerender = false;
---

<BaseLayout title="Inventario - Arte Entre Puntadas">
  <Navbar client:load />
  
  <!-- Pantalla de carga inicial -->
  <div id="auth-loading" class="min-h-screen flex items-center justify-center">
    <div class="text-center">
      <div class="flex justify-center mb-4">
        <svg class="animate-spin h-12 w-12 text-primary-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      </div>
      <p class="text-gray-400">Verificando sesión...</p>
    </div>
  </div>
  
  <!-- Contenido protegido (oculto inicialmente) -->
  <div id="protected-content" style="display: none;">
    <div class="pt-24 pb-12 px-6">
      <div class="max-w-7xl mx-auto">
        <div class="mb-10">
          <h1 class="text-4xl md:text-5xl font-display font-bold mb-4">
            <span class="gradient-text">Inventario</span> de Materiales
          </h1>
          <p class="text-xl text-dark-500">
            Administra tus hilos, rellenos y accesorios
          </p>
        </div>

        <InventarioMateriales client:load />
      </div>
    </div>
  </div>
  
  <!-- Verificación de autenticación en el cliente -->
  <script>
    import { supabase } from '../../lib/supabase';
    
    async function verificarAuth() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        // No hay sesión, abrir modal de login
        setTimeout(() => {
          window.dispatchEvent(new CustomEvent('open-login-modal'));
        }, 100);
        
        // Escuchar cambios de autenticación
        const { data: { subscription } } = supabase.auth.onAuthStateChange((event: string, newSession: any) => {
          if (event === 'SIGNED_IN' && newSession) {
            const loading = document.getElementById('auth-loading');
            const content = document.getElementById('protected-content');
            if (loading) loading.style.display = 'none';
            if (content) content.style.display = 'block';
            subscription.unsubscribe();
          }
        });
      } else {
        const loading = document.getElementById('auth-loading');
        const content = document.getElementById('protected-content');
        if (loading) loading.style.display = 'none';
        if (content) content.style.display = 'block';
      }
    }
    
    verificarAuth();
  </script>
</BaseLayout>
